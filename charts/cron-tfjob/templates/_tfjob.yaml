{{- define "arena.tfjob" -}}
{{- $gpuCount := .Values.tfjob.gpuCount -}}
{{- $psGpuCount := .Values.tfjob.psGPU -}}
{{- $syncMode := .Values.tfjob.syncMode -}}
{{- $cleanPodPolicy := .Values.tfjob.cleanPodPolicy -}}
{{- $dataDirs := .Values.tfjob.dataDirs -}}
{{- $tfNodeSelectors :=.Values.tfjob.tfNodeSelectors -}}
apiVersion: "kubeflow.org/v1"
kind: "TFJob"
metadata:
  labels:
    app: "tfjob"
    chart: {{ template "tfjob.chart" . }}
    release: {{ .Release.Name }}
    heritage: {{ .Release.Service }}
    createdBy: "Cron"
spec:
{{- if .Values.tfjob.cleanPodPolicy }}
{{- if eq "None" $cleanPodPolicy }}
  cleanPodPolicy: None
{{- end }}
{{- if eq "Running" $cleanPodPolicy }}
  cleanPodPolicy: Running
{{- end }}
{{- end }}
  tfReplicaSpecs:
{{- if .Values.tfjob.ps }}
    PS:
      replicas: {{ .Values.tfjob.ps }}
      restartPolicy: Never
      template:
        metadata:
          labels:
            app: "tfjob"
            chart: {{ template "tfjob.chart" . }}
            release: {{ .Release.Name }}
            heritage: {{ .Release.Service }}
            createdBy: "Cron"
          annotations:
          {{- range $key, $value := .Values.tfjob.annotations }}
            {{ $key }}: {{ $value | quote }}
          {{- end }}
        spec:
          {{- if ne (len $tfNodeSelectors.PS) 0 }}
          nodeSelector:
          {{- range $nodeKey,$nodeVal := $tfNodeSelectors.PS }}
            {{ $nodeKey }}: "{{ $nodeVal }}"
          {{- end }}
          {{- end }}
          {{- if ne (len .Values.tfjob.tolerations) 0 }}
          tolerations:
          {{- range $tolerationKey := .Values.tfjob.tolerations }}
            {{- if eq $tolerationKey "all" }}
            - operator: "Exists"
            {{- else }}
            - key: "{{ $tolerationKey }}"
              operator: "Exists"
            {{- end }}
          {{- end }}
          {{- end }}
          {{- if .Values.tfjob.priorityClassName }}
          priorityClassName: {{ .Values.tfjob.priorityClassName }}
          {{- end }}
          {{- if .Values.tfjob.ps }}
          {{- if .Values.tfjob.hasGangScheduler }}
          {{- if .Values.tfjob.enableGangScheduler }}
          schedulerName: {{ .Values.tfjob.schedulerName }}
          {{- end }}
          {{- end }}
          {{- end }}
          {{- if .Values.tfjob.binpack }}
          affinity:
            podAffinity:
              preferredDuringSchedulingIgnoredDuringExecution:
              - weight: 100
                podAffinityTerm:
                  topologyKey: kubernetes.io/hostname
                  labelSelector:
                    matchExpressions:
                      - key: release
                        operator: In
                        values:
                          - "{{ .Release.Name }}"
                      - key: group-name
                        operator: In
                        values:
                          - "kubeflow.org"
              - weight: 60
                podAffinityTerm:
                  topologyKey: kubernetes.io/hostname
                  labelSelector:
                    matchExpressions:
                      - key: tf-replica-type
                        operator: In
                        values:
                          - worker
              - weight: 30
                podAffinityTerm:
                  topologyKey: kubernetes.io/hostname
                  labelSelector:
                    matchExpressions:
                      - key: tf-replica-type
                        operator: In
                        values:
                          - ps      
          {{- end }}
          {{- if .Values.tfjob.useHostNetwork }}
          {{- if not .Values.tfjob.useENI }}
          hostNetwork: {{ .Values.tfjob.useHostNetwork }}
          dnsPolicy: ClusterFirstWithHostNet
          {{- end }}
          {{- end }}
          {{- if .Values.tfjob.useHostPID }}
          hostPID: {{ .Values.tfjob.useHostPID }}
          {{- end }}
          {{- if .Values.tfjob.useHostIPC }}
          hostIPC: {{ .Values.tfjob.useHostIPC }}
          {{- end }}
          {{- if .Values.tfjob.enablePodSecurityContext }}
          {{- if .Values.tfjob.isNonRoot}}
          securityContext:
            runAsUser: {{ .Values.tfjob.podSecurityContext.runAsUser }}
            runAsGroup: {{ .Values.tfjob.podSecurityContext.runAsGroup }}
            runAsNonRoot: {{ .Values.tfjob.podSecurityContext.runAsNonRoot }}
            supplementalGroups:
              {{- range $group := .Values.tfjob.podSecurityContext.supplementalGroups }}
              - {{ $group -}}
              {{ end }}
          {{- end }}
          {{- end }}
          volumes:
            {{- if ne (len .Values.tfjob.configFiles) 0 }}
            {{- $releaseName := .Release.Name }}
            {{- range $containerPathKey,$configFileInfos := .Values.tfjob.configFiles }}
            - name: {{ $containerPathKey }}
              configMap:
                name: {{ $releaseName }}-{{ $containerPathKey }}
            {{- end }}
            {{- end }}
            {{- if .Values.tfjob.syncMode }}
            - name: code-sync
              emptyDir: {}
            {{- end}}
            {{- if .Values.tfjob.nvidiaPath }}
            - hostPath:
                path: "{{ .Values.tfjob.nvidiaPath }}"
              name: nvidia
            {{- end }}
            {{- if .Values.tfjob.dataset }}
            {{- range $pvcName, $destPath := .Values.tfjob.dataset }}
            - name: "{{ $pvcName }}"
              persistentVolumeClaim:
                claimName: "{{ $pvcName }}"
            {{- end }}
            {{- end }}
            {{- if $dataDirs }}
            {{- range $dataDirs }}
            - hostPath:
                path: {{ .hostPath }}
              name: {{ .name }}
            {{- end }}
            {{- end }}
          {{- if .Values.tfjob.syncMode }}
          initContainers:
          - name: init-code
            {{- if .Values.tfjob.syncImage }}
            image: "{{ .Values.tfjob.syncImage }}"
            {{- else }}
            {{- if eq .Values.tfjob.syncMode "rsync" }}
            image: "{{ .Values.tfjob.rsyncImage }}"
            {{- end }}
            {{- if eq .Values.tfjob.syncMode "git" }}
            image: "{{ .Values.tfjob.gitImage }}"
            {{- end }}
            {{- end }}
            imagePullPolicy: {{ .Values.tfjob.imagePullPolicy }}
            {{- if eq "rsync" $syncMode }}
            command: ["rsync", "-avP", "{{ .Values.tfjob.syncSource}}", "/code"]
            {{- end }}
            resources:
              requests:
                {{- if .Values.tfjob.psCPU }}
                cpu: {{ .Values.tfjob.psCPU | quote }}
                {{- end}}
                {{- if .Values.tfjob.psMemory }}
                memory: {{ .Values.tfjob.psMemory | quote }}
                {{- end}}
              limits:
                {{- if .Values.tfjob.psCPU }}
                cpu: {{ .Values.tfjob.psCPU | quote }}
                {{- end}}
                {{- if .Values.tfjob.psMemory }}
                memory: {{ .Values.tfjob.psMemory | quote }}
                {{- end}}
            env:
            {{- range $key, $value := .Values.tfjob.envs }}
              - name: "{{ $key }}"
                value: "{{ $value }}"
            {{- end }}
            {{- if eq "git" $syncMode }}
              - name: GIT_SYNC_REPO
                value: {{ .Values.tfjob.syncSource}}
              - name: GIT_SYNC_DEST
                value: {{ .Values.tfjob.syncGitProjectName}}
              - name: GIT_SYNC_ROOT
                value: /code
              - name: GIT_SYNC_ONE_TIME
                value: "true"
            {{- end }}
            volumeMounts:
              - name: code-sync
                mountPath: /code
          {{- end}}
          {{- if ne (len .Values.tfjob.imagePullSecrets) 0 }}
          imagePullSecrets:
          {{- range $imagePullSecret := .Values.tfjob.imagePullSecrets }}
            - name: "{{ $imagePullSecret }}"
          {{- end }}
          {{- end }}
          containers:
            - name: tensorflow
              image: {{ .Values.tfjob.psImage }}
              imagePullPolicy: {{ .Values.tfjob.imagePullPolicy }}
              {{- if .Values.tfjob.workingDir }}
              workingDir: {{ .Values.tfjob.workingDir }}
              {{- end }}
              {{- if .Values.tfjob.privileged }}
              securityContext:
                privileged: true
              {{- else if .Values.tfjob.enableRDMA }}
              securityContext:
                capabilities:
                  add:
                  - IPC_LOCK
              {{- end }}
              resources:
                requests:
                  {{- if gt (int $psGpuCount) 0}}
                  nvidia.com/gpu: {{ .Values.tfjob.psGPU | quote }}
                  {{- end }}
                  {{- if .Values.tfjob.psCPU }}
                  cpu: {{ .Values.tfjob.psCPU | quote }}
                  {{- end}}
                  {{- if .Values.tfjob.psMemory }}
                  memory: {{ .Values.tfjob.psMemory | quote }}
                  {{- end}}
                  {{- if .Values.tfjob.enableRDMA }}
                  rdma/hca: "1"
                  {{- end}}
                limits:
                  {{- if gt (int $psGpuCount) 0}}
                  nvidia.com/gpu: {{ .Values.tfjob.psGPU | quote }}
                  {{- end }}
                  {{- if .Values.tfjob.psCPU }}
                  cpu: {{ .Values.tfjob.psCPU | quote }}
                  {{- end}}
                  {{- if .Values.tfjob.psMemory }}
                  memory: {{ .Values.tfjob.psMemory | quote }}
                  {{- end}}
                  {{- if .Values.tfjob.enableRDMA }}
                  rdma/hca: "1"
                  {{- end}}
              {{- if .Values.tfjob.psPort }}
              ports:
                - containerPort: {{ .Values.tfjob.psPort }}
                  name: tfjob-port
              {{- end}}
              command:
                - "{{ .Values.tfjob.shell }}"
                - "-c"
                - {{ .Values.tfjob.command }}
              env:
              {{- range $key, $value := .Values.tfjob.envs }}
                - name: "{{ $key }}"
                  value: "{{ $value }}"
              {{- end }}
              volumeMounts:
                {{- if ne (len .Values.tfjob.configFiles) 0 }}
                {{- $releaseName := .Release.Name }}
                {{- range $containerPathKey,$configFileInfos := .Values.tfjob.configFiles }}
                {{- $visit := "false" }}
                {{- range $cofigFileKey,$configFileInfo := $configFileInfos }}
                {{- if eq  "false" $visit }}
                - mountPath: {{ $configFileInfo.containerFilePath }}
                  name: {{ $containerPathKey }}
                {{- $visit = "true" }}
                {{- end }}
                {{- end }}
                {{- end }}
                {{- end }}
                {{- if .Values.tfjob.syncMode }}
                {{- if .Values.tfjob.workingDir }}
                - name: code-sync
                  mountPath: {{ .Values.tfjob.workingDir }}/code
                {{- else }}
                - name: code-sync
                  mountPath: /code
                {{- end}}
                {{- end}}
                {{- if .Values.tfjob.dataset }}
                {{- range $pvcName, $destPath := .Values.tfjob.dataset }}
                - name: "{{ $pvcName }}"
                  mountPath: "{{ $destPath }}"
                {{- end }}
                {{- end }}
                {{- if $dataDirs }}
                {{- range $dataDirs }}
                - mountPath: {{ .containerPath }}
                  name: {{ .name }}
                {{- end }}
                {{- end }}
{{- end }}
{{- if .Values.tfjob.workers }}
    Worker:
      replicas: {{ .Values.tfjob.workers }}
      {{- if .Values.tfjob.chief }}
      restartPolicy: OnFailure
      {{- else }}
      restartPolicy: Never
      {{- end }}
      template:
        metadata:
          labels:
            app: "tfjob"
            chart: {{ template "tfjob.chart" . }}
            release: {{ .Release.Name }}
            heritage: {{ .Release.Service }}
            createdBy: "Cron"
          annotations:
          {{- range $key, $value := .Values.tfjob.annotations }}
            {{ $key }}: {{ $value | quote }}
          {{- end }}
        spec:
          {{- if ne (len $tfNodeSelectors.Worker) 0 }}
          nodeSelector:
          {{- range $nodeKey,$nodeVal := $tfNodeSelectors.Worker }}
            {{ $nodeKey }}: "{{ $nodeVal }}"
          {{- end }}
          {{- end }}
          {{- if ne (len .Values.tfjob.tolerations) 0 }}
          tolerations:
          {{- range $tolerationKey := .Values.tfjob.tolerations }}
            {{- if eq $tolerationKey "all" }}
            - operator: "Exists"
            {{- else }}
            - key: "{{ $tolerationKey }}"
              operator: "Exists"
            {{- end }}
          {{- end }}
          {{- end }}
          {{- if .Values.tfjob.priorityClassName }}
          priorityClassName: {{ .Values.tfjob.priorityClassName }}
          {{- end }}
          {{- if .Values.tfjob.ps }}
          {{- if .Values.tfjob.hasGangScheduler }}
          {{- if .Values.tfjob.enableGangScheduler }}
          schedulerName: {{ .Values.tfjob.schedulerName }}
          {{- end }}
          {{- end }}
          {{- end }}
          {{- if .Values.tfjob.ps }}
          {{- if .Values.tfjob.binpack }}
          affinity:
            podAffinity:
              preferredDuringSchedulingIgnoredDuringExecution:
              - weight: 100
                podAffinityTerm:
                  topologyKey: kubernetes.io/hostname
                  labelSelector:
                    matchExpressions:
                      - key: release
                        operator: In
                        values:
                          - "{{ .Release.Name }}"
                      - key: group-name
                        operator: In
                        values:
                          - "kubeflow.org"
              - weight: 60
                podAffinityTerm:
                  topologyKey: kubernetes.io/hostname
                  labelSelector:
                    matchExpressions:
                      - key: tf-replica-type
                        operator: In
                        values:
                          - ps
              - weight: 30
                podAffinityTerm:
                  topologyKey: kubernetes.io/hostname
                  labelSelector:
                    matchExpressions:
                      - key: tf-replica-type
                        operator: In
                        values:
                          - worker
          {{- end }}
          {{- end }}
          {{- if .Values.tfjob.useHostNetwork }}
          {{- if not .Values.tfjob.useENI }}
          hostNetwork: {{ .Values.tfjob.useHostNetwork }}
          dnsPolicy: ClusterFirstWithHostNet
          {{- end }}
          {{- end }}
          {{- if .Values.tfjob.useHostPID }}
          hostPID: {{ .Values.tfjob.useHostPID }}
          {{- end }}
          {{- if .Values.tfjob.useHostIPC }}
          hostIPC: {{ .Values.tfjob.useHostIPC }}
          {{- end }}
          {{- if .Values.tfjob.enablePodSecurityContext }}
          {{- if .Values.tfjob.isNonRoot}}
          securityContext:
            runAsUser: {{ .Values.tfjob.podSecurityContext.runAsUser }}
            runAsGroup: {{ .Values.tfjob.podSecurityContext.runAsGroup }}
            runAsNonRoot: {{ .Values.tfjob.podSecurityContext.runAsNonRoot }}
            supplementalGroups:
              {{- range $group := .Values.tfjob.podSecurityContext.supplementalGroups }}
              - {{ $group -}}
              {{ end }}
          {{- end }}
          {{- end }}
          volumes:
            {{- if ne (len .Values.tfjob.configFiles) 0 }}
            {{- $releaseName := .Release.Name }}
            {{- range $containerPathKey,$configFileInfos := .Values.tfjob.configFiles }}
            - name: {{ $containerPathKey }}
              configMap:
                name: {{ $releaseName }}-{{ $containerPathKey }}
            {{- end }}
            {{- end }}
            {{- if .Values.tfjob.useTensorboard }}
            {{- if .Values.tfjob.isLocalLogging }}
            - hostPath:
                path: "{{ .Values.tfjob.hostLogPath }}"
              name: training-logs-volume
            {{- end}}
            {{- end}}
            {{- if .Values.tfjob.syncMode }}
            - name: code-sync
              emptyDir: {}
            {{- end}}
            {{- if gt (int $gpuCount) 0}}
            {{- if .Values.tfjob.nvidiaPath }}
            - hostPath:
                path: "{{ .Values.tfjob.nvidiaPath }}"
              name: nvidia
            {{- end }}
            {{- end }}
            {{- if .Values.tfjob.dataset }}
            {{- range $pvcName, $destPath := .Values.tfjob.dataset }}
            - name: "{{ $pvcName }}"
              persistentVolumeClaim:
                claimName: "{{ $pvcName }}"
            {{- end }}
            {{- end }}
            {{- if $dataDirs }}
            {{- range $dataDirs }}
            - hostPath:
                path: {{ .hostPath }}
              name: {{ .name }}
            {{- end }}
            {{- end }}
          {{- if .Values.tfjob.syncMode }}
          initContainers:
          - name: init-code
            {{- if .Values.tfjob.syncImage }}
            image: "{{ .Values.tfjob.syncImage }}"
            {{- else }}
            {{- if eq .Values.tfjob.syncMode "rsync" }}
            image: "{{ .Values.tfjob.rsyncImage }}"
            {{- end }}
            {{- if eq .Values.tfjob.syncMode "git" }}
            image: "{{ .Values.tfjob.gitImage }}"
            {{- end }}
            {{- end }}
            imagePullPolicy: {{ .Values.tfjob.imagePullPolicy }}
            {{- if eq "rsync" $syncMode }}
            command: ["rsync", "-avP", "{{ .Values.tfjob.syncSource}}", "/code"]
            {{- end }}
            resources:
              requests:
                  {{- if .Values.tfjob.workerCPU }}
                  cpu: {{ .Values.tfjob.workerCPU | quote }}
                  {{- end}}
                  {{- if .Values.tfjob.workerMemory }}
                  memory: {{ .Values.tfjob.workerMemory | quote }}
                  {{- end}}
              limits:
                  {{- if .Values.tfjob.workerCPU }}
                  cpu: {{ .Values.tfjob.workerCPU | quote }}
                  {{- end}}
                  {{- if .Values.tfjob.workerMemory }}
                  memory: {{ .Values.tfjob.workerMemory | quote }}
                  {{- end}}
            env:
            {{- range $key, $value := .Values.tfjob.envs }}
              - name: "{{ $key }}"
                value: "{{ $value }}"
            {{- end }}
            {{- if eq "git" $syncMode }}
              - name: GIT_SYNC_REPO
                value: {{ .Values.tfjob.syncSource}}
              - name: GIT_SYNC_DEST
                value: {{ .Values.tfjob.syncGitProjectName}}
              - name: GIT_SYNC_ROOT
                value: /code
              - name: GIT_SYNC_ONE_TIME
                value: "true"
            {{- end }}
            volumeMounts:
              - name: code-sync
                mountPath: /code
          {{- end}}
          {{- if ne (len .Values.tfjob.imagePullSecrets) 0 }}
          imagePullSecrets:
          {{- range $imagePullSecret := .Values.tfjob.imagePullSecrets }}
            - name: "{{ $imagePullSecret }}"
          {{- end }}
          {{- end }}
          containers:
            - name: tensorflow
              image: {{ .Values.tfjob.workerImage }}
              imagePullPolicy: {{ .Values.tfjob.imagePullPolicy }}
              {{- if .Values.tfjob.workingDir }}
              workingDir: {{ .Values.tfjob.workingDir }}
              {{- end }}
              {{- if .Values.tfjob.privileged }}
              securityContext:
                privileged: true
              {{- else if .Values.tfjob.enableRDMA }}
              securityContext:
                capabilities:
                  add:
                  - IPC_LOCK
              {{- end }}
              resources:
                requests:
                  {{- if gt (int $gpuCount) 0}}
                  {{- if .Values.tfjob.nvidiaPath }}
                  alpha.kubernetes.io/nvidia-gpu: {{ $gpuCount | quote }}
                  {{- else}}
                  nvidia.com/gpu: {{ $gpuCount | quote }}
                  {{- end}}
                  {{- end}}
                  {{- if .Values.tfjob.workerCPU }}
                  cpu: {{ .Values.tfjob.workerCPU | quote }}
                  {{- end}}
                  {{- if .Values.tfjob.workerMemory }}
                  memory: {{ .Values.tfjob.workerMemory | quote }}
                  {{- end}}
                  {{- if .Values.tfjob.enableRDMA }}
                  rdma/hca: "1"
                  {{- end}}
                limits:
                  {{- if gt (int $gpuCount) 0}}
                  {{- if .Values.tfjob.nvidiaPath }}
                  alpha.kubernetes.io/nvidia-gpu: {{ $gpuCount | quote }}
                  {{- else}}
                  nvidia.com/gpu: {{ $gpuCount | quote }}
                  {{- end}}
                  {{- end}}
                  {{- if .Values.tfjob.workerCPU }}
                  cpu: {{ .Values.tfjob.workerCPU | quote }}
                  {{- end}}
                  {{- if .Values.tfjob.workerMemory }}
                  memory: {{ .Values.tfjob.workerMemory | quote }}
                  {{- end}}
                  {{- if .Values.tfjob.enableRDMA }}
                  rdma/hca: "1"
                  {{- end}}
              {{- if .Values.tfjob.workerPort }}
              ports:
                - containerPort: {{ .Values.tfjob.workerPort }}
                  name: tfjob-port
              {{- end}}
              command:
                - "{{ .Values.tfjob.shell }}"
                - "-c"
                - {{ .Values.tfjob.command }}
              env:
              {{- range $key, $value := .Values.tfjob.envs }}
                - name: "{{ $key }}"
                  value: "{{ $value }}"
              {{- end }}
              volumeMounts:
                {{- if ne (len .Values.tfjob.configFiles) 0 }}
                {{- $releaseName := .Release.Name }}
                {{- range $containerPathKey,$configFileInfos := .Values.tfjob.configFiles }}
                {{- $visit := "false" }}
                {{- range $cofigFileKey,$configFileInfo := $configFileInfos }}
                {{- if eq  "false" $visit }}
                - mountPath: {{ $configFileInfo.containerFilePath }}
                  name: {{ $containerPathKey }}
                {{- $visit = "true" }}
                {{- end }}
                {{- end }}
                {{- end }}
                {{- end }}
                {{- if (not .Values.tfjob.chief) }}
                {{- if .Values.tfjob.useTensorboard }}
                {{- if .Values.tfjob.isLocalLogging }}
                - mountPath: {{ .Values.tfjob.trainingLogdir }}
                  name: training-logs-volume
                {{- end}}
                {{- end}}
                {{- end}}
                {{- if .Values.tfjob.syncMode }}
                {{- if .Values.tfjob.workingDir }}
                - name: code-sync
                  mountPath: {{ .Values.tfjob.workingDir }}/code
                {{- else }}
                - name: code-sync
                  mountPath: /code
                {{- end}}
                {{- end}}
                {{- if .Values.tfjob.dataset }}
                {{- range $pvcName, $destPath := .Values.tfjob.dataset }}
                - name: "{{ $pvcName }}"
                  mountPath: "{{ $destPath }}"
                {{- end }}
                {{- end }}
                {{- if gt (int $gpuCount) 0}}
                {{- if .Values.tfjob.nvidiaPath }}
                - mountPath: /usr/local/nvidia
                  name: nvidia
                {{- end }}
                {{- end }}
                {{- if $dataDirs }}
                {{- range $dataDirs }}
                - mountPath: {{ .containerPath }}
                  name: {{ .name }}
                {{- end }}
                {{- end }}

{{- end }}
{{- if .Values.tfjob.chief }}
{{ .Values.tfjob.chiefName | indent  4}}:
      restartPolicy: Never
      replicas: 1
      template:
        metadata:
          labels:
            app: "tfjob"
            chart: {{ template "tfjob.chart" . }}
            release: {{ .Release.Name }}
            heritage: {{ .Release.Service }}
            createdBy: "Cron"
          annotations:
          {{- range $key, $value := .Values.tfjob.annotations }}
            {{ $key }}: {{ $value | quote }}
          {{- end }}
        spec:
          {{- if ne (len $tfNodeSelectors.Chief) 0 }}
          nodeSelector:
          {{- range $nodeKey,$nodeVal := $tfNodeSelectors.Chief }}
            {{ $nodeKey }}: "{{ $nodeVal }}"
          {{- end }}
          {{- end }}
          {{- if ne (len .Values.tfjob.tolerations) 0 }}
          tolerations:
          {{- range $tolerationKey := .Values.tfjob.tolerations }}
            {{- if eq $tolerationKey "all" }}
            - operator: "Exists"
            {{- else }}
            - key: "{{ $tolerationKey }}"
              operator: "Exists"
            {{- end }}
          {{- end }}
          {{- end }}
          {{- if .Values.tfjob.priorityClassName }}
          priorityClassName: {{ .Values.tfjob.priorityClassName }}
          {{- end }}
          {{- if .Values.tfjob.ps }}
          {{- if .Values.tfjob.hasGangScheduler }}
          {{- if .Values.tfjob.enableGangScheduler }}
          schedulerName: {{ .Values.tfjob.schedulerName }}
          {{- end }}
          {{- end }}
          {{- end }}
          {{- if .Values.tfjob.ps }}
          {{- if .Values.tfjob.binpack }}
          affinity:
            podAffinity:
              preferredDuringSchedulingIgnoredDuringExecution:
              - weight: 100
                podAffinityTerm:
                  topologyKey: kubernetes.io/hostname
                  labelSelector:
                    matchExpressions:
                      - key: release
                        operator: In
                        values:
                          - "{{ .Release.Name }}"
                      - key: group-name
                        operator: In
                        values:
                          - "kubeflow.org"
              - weight: 60
                podAffinityTerm:
                  topologyKey: kubernetes.io/hostname
                  labelSelector:
                    matchExpressions:
                      - key: tf-replica-type
                        operator: In
                        values:
                          - ps
              - weight: 30
                podAffinityTerm:
                  topologyKey: kubernetes.io/hostname
                  labelSelector:
                    matchExpressions:
                      - key: tf-replica-type
                        operator: In
                        values:
                          - worker
          {{- end }}
          {{- end }}
          {{- if .Values.tfjob.useHostNetwork }}
          {{- if not .Values.tfjob.useENI }}
          hostNetwork: {{ .Values.tfjob.useHostNetwork }}
          dnsPolicy: ClusterFirstWithHostNet
          {{- end }}
          {{- end }}
          {{- if .Values.tfjob.useHostPID }}
          hostPID: {{ .Values.tfjob.useHostPID }}
          {{- end }}
          {{- if .Values.tfjob.useHostIPC }}
          hostIPC: {{ .Values.tfjob.useHostIPC }}
          {{- end }}
          {{- if .Values.tfjob.enablePodSecurityContext }}
          {{- if .Values.tfjob.isNonRoot}}
          securityContext:
            runAsUser: {{ .Values.tfjob.podSecurityContext.runAsUser }}
            runAsGroup: {{ .Values.tfjob.podSecurityContext.runAsGroup }}
            runAsNonRoot: {{ .Values.tfjob.podSecurityContext.runAsNonRoot }}
            supplementalGroups:
              {{- range $group := .Values.tfjob.podSecurityContext.supplementalGroups }}
              - {{ $group -}}
              {{ end }}
          {{- end }}
          {{- end }}
          volumes:
            {{- if ne (len .Values.tfjob.configFiles) 0 }}
            {{- $releaseName := .Release.Name }}
            {{- range $containerPathKey,$configFileInfos := .Values.tfjob.configFiles }}
            - name: {{ $containerPathKey }}
              configMap:
                name: {{ $releaseName }}-{{ $containerPathKey }}
            {{- end }}
            {{- end }}
            {{- if .Values.tfjob.useTensorboard }}
            {{- if .Values.tfjob.isLocalLogging }}
            - hostPath:
                path: "{{ .Values.tfjob.hostLogPath }}"
              name: training-logs-volume
            {{- end}}
            {{- end}}
            {{- if .Values.tfjob.syncMode }}
            - name: code-sync
              emptyDir: {}
            {{- end}}
            {{- if gt (int $gpuCount) 0}}
            {{- if .Values.tfjob.nvidiaPath }}
            - hostPath:
                path: "{{ .Values.tfjob.nvidiaPath }}"
              name: nvidia
            {{- end }}
            {{- end }}
            {{- if .Values.tfjob.dataset }}
            {{- range $pvcName, $destPath := .Values.tfjob.dataset }}
            - name: "{{ $pvcName }}"
              persistentVolumeClaim:
                claimName: "{{ $pvcName }}"
            {{- end }}
            {{- end }}
            {{- if $dataDirs }}
            {{- range $dataDirs }}
            - hostPath:
                path: {{ .hostPath }}
              name: {{ .name }}
            {{- end }}
            {{- end }}
          {{- if .Values.tfjob.syncMode }}
          initContainers:
          - name: init-code
            {{- if .Values.tfjob.syncImage }}
            image: "{{ .Values.tfjob.syncImage }}"
            {{- else }}
            {{- if eq .Values.tfjob.syncMode "rsync" }}
            image: "{{ .Values.tfjob.rsyncImage }}"
            {{- end }}
            {{- if eq .Values.tfjob.syncMode "git" }}
            image: "{{ .Values.tfjob.gitImage }}"
            {{- end }}
            {{- end }}
            imagePullPolicy: {{ .Values.tfjob.imagePullPolicy }}
            {{- if eq "rsync" $syncMode }}
            command: ["rsync", "-avP", "{{ .Values.tfjob.syncSource}}", "/code"]
            {{- end }}
            resources:
              requests:
                  {{- if .Values.tfjob.chiefCPU }}
                  cpu: {{ .Values.tfjob.chiefCPU | quote }}
                  {{- end}}
                  {{- if .Values.tfjob.chiefMemory }}
                  memory: {{ .Values.tfjob.chiefMemory | quote }}
                  {{- end}}
              limits:
                  {{- if .Values.tfjob.chiefCPU }}
                  cpu: {{ .Values.tfjob.chiefCPU | quote }}
                  {{- end}}
                  {{- if .Values.tfjob.chiefMemory }}
                  memory: {{ .Values.tfjob.chiefMemory | quote }}
                  {{- end}}
            env:
            {{- range $key, $value := .Values.tfjob.envs }}
              - name: "{{ $key }}"
                value: "{{ $value }}"
            {{- end }}
            {{- if eq "git" $syncMode }}
              - name: GIT_SYNC_REPO
                value: {{ .Values.tfjob.syncSource}}
              - name: GIT_SYNC_DEST
                value: {{ .Values.tfjob.syncGitProjectName}}
              - name: GIT_SYNC_ROOT
                value: /code
              - name: GIT_SYNC_ONE_TIME
                value: "true"
            {{- end }}
            volumeMounts:
              - name: code-sync
                mountPath: /code
          {{- end}}
          {{- if ne (len .Values.tfjob.imagePullSecrets) 0 }}
          imagePullSecrets:
          {{- range $imagePullSecret := .Values.tfjob.imagePullSecrets }}
            - name: "{{ $imagePullSecret }}"
          {{- end }}
          {{- end }}
          containers:
            - name: tensorflow
              image: {{ .Values.tfjob.workerImage }}
              imagePullPolicy: {{ .Values.tfjob.imagePullPolicy }}
              {{- if .Values.tfjob.workingDir }}
              workingDir: {{ .Values.tfjob.workingDir }}
              {{- end }}
              {{- if .Values.tfjob.privileged }}
              securityContext:
                privileged: true
              {{- else if .Values.tfjob.enableRDMA }}
              securityContext:
                capabilities:
                  add:
                  - IPC_LOCK
              {{- end }}
              resources:
                requests:
                  {{- if gt (int $gpuCount) 0}}
                  {{- if .Values.tfjob.nvidiaPath }}
                  alpha.kubernetes.io/nvidia-gpu: {{ $gpuCount | quote }}
                  {{- else}}
                  nvidia.com/gpu: {{ $gpuCount | quote }}
                  {{- end}}
                  {{- end}}
                  {{- if .Values.tfjob.chiefCPU }}
                  cpu: {{ .Values.tfjob.chiefCPU | quote }}
                  {{- end}}
                  {{- if .Values.tfjob.chiefMemory }}
                  memory: {{ .Values.tfjob.chiefMemory | quote }}
                  {{- end}}
                  {{- if .Values.tfjob.enableRDMA }}
                  rdma/hca: "1"
                  {{- end}}
                limits:
                  {{- if gt (int $gpuCount) 0}}
                  {{- if .Values.tfjob.nvidiaPath }}
                  alpha.kubernetes.io/nvidia-gpu: {{ $gpuCount | quote }}
                  {{- else}}
                  nvidia.com/gpu: {{ $gpuCount | quote }}
                  {{- end}}
                  {{- end}}
                  {{- if .Values.tfjob.chiefCPU }}
                  cpu: {{ .Values.tfjob.chiefCPU | quote }}
                  {{- end}}
                  {{- if .Values.tfjob.chiefMemory }}
                  memory: {{ .Values.tfjob.chiefMemory | quote }}
                  {{- end}}
                  {{- if .Values.tfjob.enableRDMA }}
                  rdma/hca: "1"
                  {{- end}}
              {{- if .Values.tfjob.chiefPort }}
              ports:
                - containerPort: {{ .Values.tfjob.chiefPort }}
                  name: tfjob-port
              {{- end}}
              command:
                - "{{ .Values.tfjob.shell }}"
                - "-c"
                - {{ .Values.tfjob.command }}
              env:
              {{- range $key, $value := .Values.tfjob.envs }}
                - name: "{{ $key }}"
                  value: "{{ $value }}"
              {{- end }}
              volumeMounts:
                {{- if ne (len .Values.tfjob.configFiles) 0 }}
                {{- $releaseName := .Release.Name }}
                {{- range $containerPathKey,$configFileInfos := .Values.tfjob.configFiles }}
                {{- $visit := "false" }}
                {{- range $cofigFileKey,$configFileInfo := $configFileInfos }}
                {{- if eq  "false" $visit }}
                - mountPath: {{ $configFileInfo.containerFilePath }}
                  name: {{ $containerPathKey }}
                {{- $visit = "true" }}
                {{- end }}
                {{- end }}
                {{- end }}
                {{- end }}
                {{- if .Values.tfjob.useTensorboard }}
                {{- if .Values.tfjob.isLocalLogging }}
                - mountPath: {{ .Values.tfjob.trainingLogdir }}
                  name: training-logs-volume
                {{- end}}
                {{- end}}
                {{- if .Values.tfjob.syncMode }}
                {{- if .Values.tfjob.workingDir }}
                - name: code-sync
                  mountPath: {{ .Values.tfjob.workingDir }}/code
                {{- else }}
                - name: code-sync
                  mountPath: /code
                {{- end}}
                {{- end}}
                {{- if .Values.tfjob.dataset }}
                {{- range $pvcName, $destPath := .Values.tfjob.dataset }}
                - name: "{{ $pvcName }}"
                  mountPath: "{{ $destPath }}"
                {{- end }}
                {{- end }}
                {{- if gt (int $gpuCount) 0}}
                {{- if .Values.tfjob.nvidiaPath }}
                - mountPath: /usr/local/nvidia
                  name: nvidia
                {{- end }}
                {{- end }}
                {{- if $dataDirs }}
                {{- range $dataDirs }}
                - mountPath: {{ .containerPath }}
                  name: {{ .name }}
                {{- end }}
                {{- end }}
{{- end }}
{{- if .Values.tfjob.evaluator }}
    Evaluator:
      restartPolicy: Never
      replicas: 1
      template:
        metadata:
          labels:
            app: "tfjob"
            chart: {{ template "tfjob.chart" . }}
            release: {{ .Release.Name }}
            heritage: {{ .Release.Service }}
            createdBy: "Cron"
          annotations:
          {{- range $key, $value := .Values.tfjob.annotations }}
            {{ $key }}: {{ $value | quote }}
          {{- end }}
        spec:
          {{- if ne (len $tfNodeSelectors.Evaluator) 0 }}
          nodeSelector:
          {{- range $nodeKey,$nodeVal := $tfNodeSelectors.Evaluator }}
            {{ $nodeKey }}: "{{ $nodeVal }}"
          {{- end }}
          {{- end }}
          {{- if ne (len .Values.tfjob.tolerations) 0 }}
          tolerations:
          {{- range $tolerationKey := .Values.tfjob.tolerations }}
            {{- if eq $tolerationKey "all" }}
            - operator: "Exists"
            {{- else }}
            - key: "{{ $tolerationKey }}"
              operator: "Exists"
            {{- end }}
          {{- end }}
          {{- end }}
          {{- if .Values.tfjob.priorityClassName }}
          priorityClassName: {{ .Values.tfjob.priorityClassName }}
          {{- end }}
          {{- if .Values.tfjob.ps }}
          {{- if .Values.tfjob.hasGangScheduler }}
          {{- if .Values.tfjob.enableGangScheduler }}
          schedulerName: {{ .Values.tfjob.schedulerName }}
          {{- end }}
          {{- end }}
          {{- end }}
          {{- if .Values.tfjob.useHostNetwork }}
          {{- if not .Values.tfjob.useENI }}
          hostNetwork: {{ .Values.tfjob.useHostNetwork }}
          dnsPolicy: ClusterFirstWithHostNet
          {{- end }}
          {{- end }}
          {{- if .Values.tfjob.useHostPID }}
          hostPID: {{ .Values.tfjob.useHostPID }}
          {{- end }}
          {{- if .Values.tfjob.useHostIPC }}
          hostIPC: {{ .Values.tfjob.useHostIPC }}
          {{- end }}
          {{- if .Values.tfjob.enablePodSecurityContext }}
          {{- if .Values.tfjob.isNonRoot}}
          securityContext:
            runAsUser: {{ .Values.tfjob.podSecurityContext.runAsUser }}
            runAsGroup: {{ .Values.tfjob.podSecurityContext.runAsGroup }}
            runAsNonRoot: {{ .Values.tfjob.podSecurityContext.runAsNonRoot }}
            supplementalGroups:
              {{- range $group := .Values.tfjob.podSecurityContext.supplementalGroups }}
              - {{ $group -}}
              {{ end }}
          {{- end }}
          {{- end }}
          volumes:
            {{- if ne (len .Values.tfjob.configFiles) 0 }}
            {{- $releaseName := .Release.Name }}
            {{- range $containerPathKey,$configFileInfos := .Values.tfjob.configFiles }}
            - name: {{ $containerPathKey }}
              configMap:
                name: {{ $releaseName }}-{{ $containerPathKey }}
            {{- end }}
            {{- end }}
            {{- if .Values.tfjob.useTensorboard }}
            {{- if .Values.tfjob.isLocalLogging }}
            - hostPath:
                path: "{{ .Values.tfjob.hostLogPath }}"
              name: training-logs-volume
            {{- end}}
            {{- end}}
            {{- if .Values.tfjob.syncMode }}
            - name: code-sync
              emptyDir: {}
            {{- end}}
            {{- if gt (int $gpuCount) 0}}  
            {{- if .Values.tfjob.nvidiaPath }}
            - hostPath:
                path: "{{ .Values.tfjob.nvidiaPath }}"
              name: nvidia
            {{- end }}
            {{- end }}
            {{- if .Values.tfjob.dataset }}   
            {{- range $pvcName, $destPath := .Values.tfjob.dataset }}
            - name: "{{ $pvcName }}"
              persistentVolumeClaim:
                claimName: "{{ $pvcName }}"
            {{- end }}
            {{- end }}
            {{- if $dataDirs }}
            {{- range $dataDirs }}
            - hostPath:
                path: {{ .hostPath }}
              name: {{ .name }}
            {{- end }}
            {{- end }}
          {{- if .Values.tfjob.syncMode }}
          initContainers:
          - name: init-code
            {{- if .Values.tfjob.syncImage }}
            image: "{{ .Values.tfjob.syncImage }}"
            {{- else }}
            {{- if eq .Values.tfjob.syncMode "rsync" }}
            image: "{{ .Values.tfjob.rsyncImage }}"
            {{- end }}
            {{- if eq .Values.tfjob.syncMode "git" }}
            image: "{{ .Values.tfjob.gitImage }}"
            {{- end }}
            {{- end }}
            imagePullPolicy: {{ .Values.tfjob.imagePullPolicy }}
            {{- if eq "rsync" $syncMode }}
            command: ["rsync", "-avP", "{{ .Values.tfjob.syncSource}}", "/code"]
            {{- end }}
            resources:
              requests:
                  {{- if .Values.tfjob.evaluatorCPU }}
                  cpu: {{ .Values.tfjob.evaluatorCPU | quote }}
                  {{- end}}
                  {{- if .Values.tfjob.evaluatorMemory }}
                  memory: {{ .Values.tfjob.evaluatorMemory | quote }}
                  {{- end}}
              limits:
                  {{- if .Values.tfjob.evaluatorCPU }}
                  cpu: {{ .Values.tfjob.evaluatorCPU | quote }}
                  {{- end}}
                  {{- if .Values.tfjob.evaluatorMemory }}
                  memory: {{ .Values.tfjob.evaluatorMemory | quote }}
                  {{- end}}
            env:
            {{- range $key, $value := .Values.tfjob.envs }}
              - name: "{{ $key }}"
                value: "{{ $value }}"
            {{- end }}
            {{- if eq "git" $syncMode }}
              - name: GIT_SYNC_REPO
                value: {{ .Values.tfjob.syncSource}}
              - name: GIT_SYNC_DEST
                value: {{ .Values.tfjob.syncGitProjectName}}
              - name: GIT_SYNC_ROOT
                value: /code
              - name: GIT_SYNC_ONE_TIME
                value: "true"
            {{- end }}
            volumeMounts:
              - name: code-sync
                mountPath: /code
          {{- end}}
          {{- if ne (len .Values.tfjob.imagePullSecrets) 0 }}
          imagePullSecrets:
          {{- range $imagePullSecret := .Values.tfjob.imagePullSecrets }}
            - name: "{{ $imagePullSecret }}"
          {{- end }}
          {{- end }}
          containers:
            - name: tensorflow
              image: {{ .Values.tfjob.workerImage }}
              imagePullPolicy: {{ .Values.tfjob.imagePullPolicy }}
              {{- if .Values.tfjob.workingDir }}
              workingDir: {{ .Values.tfjob.workingDir }}
              {{- end }}
              {{- if .Values.tfjob.privileged }}
              securityContext:
                privileged: true
              {{- end }}
              resources:             
                requests:
                  {{- if gt (int $gpuCount) 0}}   
                  {{- if .Values.tfjob.nvidiaPath }}
                  alpha.kubernetes.io/nvidia-gpu: {{ $gpuCount | quote }}
                  {{- else}}
                  nvidia.com/gpu: {{ $gpuCount | quote }}
                  {{- end}}
                  {{- end}}
                  {{- if .Values.tfjob.evaluatorCPU }}
                  cpu: {{ .Values.tfjob.evaluatorCPU | quote }}
                  {{- end}}
                  {{- if .Values.tfjob.evaluatorMemory }}
                  memory: {{ .Values.tfjob.evaluatorMemory | quote }}
                  {{- end}}
                limits:
                  {{- if gt (int $gpuCount) 0}}   
                  {{- if .Values.tfjob.nvidiaPath }}
                  alpha.kubernetes.io/nvidia-gpu: {{ $gpuCount | quote }}
                  {{- else}}
                  nvidia.com/gpu: {{ $gpuCount | quote }}
                  {{- end}}
                  {{- end}}
                  {{- if .Values.tfjob.evaluatorCPU }}
                  cpu: {{ .Values.tfjob.evaluatorCPU | quote }}
                  {{- end}}
                  {{- if .Values.tfjob.evaluatorMemory }}
                  memory: {{ .Values.tfjob.evaluatorMemory | quote }}
                  {{- end}}
              command:
                - "{{ .Values.tfjob.shell }}"
                - "-c"
                - {{ .Values.tfjob.command }}
              env:        
              {{- range $key, $value := .Values.tfjob.envs }}
                - name: "{{ $key }}"
                  value: "{{ $value }}"
              {{- end }}
              volumeMounts:
                {{- if ne (len .Values.tfjob.configFiles) 0 }}
                {{- $releaseName := .Release.Name }}
                {{- range $containerPathKey,$configFileInfos := .Values.tfjob.configFiles }}
                {{- $visit := "false" }}
                {{- range $cofigFileKey,$configFileInfo := $configFileInfos }}
                {{- if eq  "false" $visit }}
                - mountPath: {{ $configFileInfo.containerFilePath }}
                  name: {{ $containerPathKey }}
                {{- $visit = "true" }}  
                {{- end }}
                {{- end }}
                {{- end }}
                {{- end }}
                {{- if .Values.tfjob.syncMode }}
                {{- if .Values.tfjob.workingDir }}
                - name: code-sync
                  mountPath: {{ .Values.tfjob.workingDir }}/code
                {{- else }}
                - name: code-sync
                  mountPath: /code
                {{- end}}
                {{- end}}
                {{- if .Values.tfjob.dataset }}   
                {{- range $pvcName, $destPath := .Values.tfjob.dataset }}
                - name: "{{ $pvcName }}"
                  mountPath: "{{ $destPath }}"
                {{- end }}
                {{- end }}
                {{- if gt (int $gpuCount) 0}}  
                {{- if .Values.tfjob.nvidiaPath }}
                - mountPath: /usr/local/nvidia
                  name: nvidia
                {{- end }}
                {{- end }}
                {{- if $dataDirs }}
                {{- range $dataDirs }}
                - mountPath: {{ .containerPath }}
                  name: {{ .name }}
                {{- end }}
                {{- end }}
{{- end }}
{{- end }}
